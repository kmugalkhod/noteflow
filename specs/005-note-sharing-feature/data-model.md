# Data Model: Note Sharing Feature

**Date**: 2025-10-28
**Feature**: 005-note-sharing-feature

## Overview

This document defines the database schema changes and entity relationships for the note sharing feature.

## New Entities

### SharedNote

Represents a note that has been shared publicly via a unique link.

**Table Name**: `sharedNotes`

**Fields**:

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `shareId` | `string` | Yes | - | Unique identifier for the share link (nanoid, 16 chars) |
| `noteId` | `Id<"notes">` | Yes | - | Reference to the original note |
| `userId` | `Id<"users">` | Yes | - | Owner of the note (for listing user's shares) |
| `isActive` | `boolean` | Yes | `true` | Whether the share link is active/valid |
| `viewCount` | `number` | Yes | `0` | Number of times the share link has been accessed |
| `lastAccessedAt` | `number` | No | - | Timestamp of most recent view (optional) |
| `createdAt` | `number` | Yes | - | Timestamp when share link was created |
| `updatedAt` | `number` | Yes | - | Timestamp of last modification |

**Indexes**:
- `by_share_id`: Index on `shareId` for fast public lookups
- `by_note`: Index on `noteId` to check if note already has share link
- `by_user`: Index on `userId` to list all shares for a user
- `by_user_active`: Compound index on `[userId, isActive]` for filtering active shares

**Validation Rules**:
- `shareId` must be unique (enforced by index)
- `shareId` must be exactly 16 characters (generated by nanoid)
- `noteId` must reference a valid note that exists and is not deleted
- `userId` must match the owner of the referenced note
- `viewCount` cannot be negative
- `isActive` can only be true/false

**State Transitions**:
- **Created** → `isActive: true, viewCount: 0`
- **Accessed** → `viewCount++, lastAccessedAt = now`
- **Revoked** → `isActive: false` (note: keep viewCount and other data for analytics)
- **Note Deleted** → `isActive: false` (automatic via trigger/hook)

---

### ShareView (Optional - Future Enhancement)

Detailed tracking of each share link access for advanced analytics.

**Table Name**: `shareViews` (Not implemented in MVP - documented for future)

**Fields**:

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `shareId` | `string` | Yes | - | Reference to SharedNote.shareId |
| `viewedAt` | `number` | Yes | - | Timestamp of access |
| `referrer` | `string` | No | - | HTTP referrer (where traffic came from) |
| `userAgent` | `string` | No | - | Browser/device info |

**Indexes**:
- `by_share_id`: Index on `shareId` for querying views per share
- `by_viewed_at`: Index on `viewedAt` for time-series analytics

**Note**: This table is not included in MVP to keep scope minimal. Can be added later for detailed analytics.

---

## Modified Entities

### Note

Existing `notes` table does not need schema changes, but queries need modifications.

**Changes to Existing Queries**:

1. **getNotes / getNotesMinimal**: Add `shareStatus` field to indicate if note has active share
   ```typescript
   // Pseudo-code
   return notes.map(note => ({
     ...note,
     hasActiveShare: await checkIfShared(note._id)
   }))
   ```

2. **deleteNote / soft-delete**: When note is deleted, deactivate related share links
   ```typescript
   // On note deletion
   const shares = await getSharesByNoteId(noteId);
   for (const share of shares) {
     await deactivateShare(share._id);
   }
   ```

**No schema changes required** - all modifications are in query logic.

---

## Entity Relationships

```text
users (1) ──────── (*) notes
  │                    │
  │                    │
  └─────────── (*) sharedNotes
                       │
                       └── references noteId
```

**Relationships**:

1. **User ←→ SharedNote** (One-to-Many)
   - One user can have many shared notes
   - Each shared note belongs to one user
   - Cascade rule: When user is deleted, all their shares should be deactivated

2. **Note ←→ SharedNote** (One-to-One or One-to-Many - TBD)
   - Current design: One note can have ONE active share link (reuse existing if user re-shares)
   - Alternative: Allow multiple share links per note with different settings
   - **Decision**: Start with One-to-One (simpler), can extend to One-to-Many later

3. **SharedNote ←→ Note** (Many-to-One)
   - Multiple shares can reference the same note (if we allow multiple links)
   - Each share references exactly one note
   - Cascade rule: When note is deleted, shares are deactivated (not deleted, for analytics)

---

## Convex Schema Definition

```typescript
// Add to convex/schema.ts

import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // ... existing tables ...

  // Shared Notes table (NEW)
  sharedNotes: defineTable({
    shareId: v.string(), // Unique nanoid (16 chars)
    noteId: v.id("notes"),
    userId: v.id("users"),
    isActive: v.boolean(),
    viewCount: v.number(),
    lastAccessedAt: v.optional(v.number()),
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_share_id", ["shareId"]) // Primary lookup for public access
    .index("by_note", ["noteId"]) // Check if note already shared
    .index("by_user", ["userId"]) // List user's shares
    .index("by_user_active", ["userId", "isActive"]), // Filter active shares

  // ... rest of existing tables ...
});
```

---

## Data Access Patterns

### Pattern 1: Generate Share Link (Authenticated)

```text
Input: noteId
Process:
  1. Verify user owns the note
  2. Check if share already exists for this note
  3. If exists and active → return existing shareId
  4. If exists but inactive → reactivate and return shareId
  5. If not exists → generate new shareId (nanoid), create SharedNote
Output: shareId (string)
```

### Pattern 2: Revoke Share Link (Authenticated)

```text
Input: shareId OR noteId
Process:
  1. Verify user owns the share
  2. Set isActive = false
  3. Update updatedAt timestamp
Output: success boolean
```

### Pattern 3: View Shared Note (Public - No Auth)

```text
Input: shareId
Process:
  1. Query sharedNotes by shareId (indexed)
  2. If not found OR isActive=false → return null
  3. Fetch note by noteId
  4. If note.isDeleted → return null
  5. Increment viewCount, update lastAccessedAt
  6. Return note content (title, content, blocks, coverImage)
Output: Public note data (no user info)
```

### Pattern 4: List User's Shared Notes (Authenticated)

```text
Input: userId (from auth context)
Process:
  1. Query sharedNotes by userId and isActive=true (indexed)
  2. For each share, fetch note title and metadata
  3. Return list with share info (shareId, viewCount, lastAccessedAt, note title)
Output: Array of shared note summaries
```

---

## Data Integrity Rules

1. **Referential Integrity**:
   - Cannot create SharedNote if note doesn't exist
   - Cannot create SharedNote if user doesn't own the note
   - If note is deleted, associated shares must be deactivated

2. **Uniqueness Constraints**:
   - `shareId` must be unique across all SharedNotes
   - One note should have at most one active share (enforced in business logic)

3. **Security Constraints**:
   - Public queries must never return user personal data (email, clerkUserId)
   - Public queries must validate `isActive` before returning data
   - Revocation must be immediate (no caching of deactivated shares)

4. **Analytics Integrity**:
   - `viewCount` should only increment (never decrease)
   - Historical data (viewCount, lastAccessedAt) preserved even after revocation

---

## Migration Notes

**Existing Data**: No migration needed - this is a new feature with new tables.

**Backwards Compatibility**: All existing note functionality remains unchanged.

**Rollback Plan**: If feature needs to be disabled, simply:
1. Remove public share route
2. Hide share UI components
3. Keep sharedNotes table (data preserved for future re-enable)

---

## Testing Considerations

1. **Create Share Link**:
   - Test creating share for owned note
   - Test creating share for non-existent note (should fail)
   - Test creating share for note owned by another user (should fail)
   - Test re-sharing already shared note (should return existing link)

2. **View Shared Note**:
   - Test valid, active share link
   - Test invalid shareId (should return not found)
   - Test revoked share link (should return not available)
   - Test share link for deleted note (should return not available)

3. **Analytics**:
   - Test viewCount increments on each access
   - Test lastAccessedAt updates correctly
   - Test viewCount persists after revocation

4. **Concurrency**:
   - Test multiple simultaneous views (race condition on viewCount)
   - Test concurrent share creation for same note

---

## Future Enhancements (Out of Scope for MVP)

1. **Password Protection**: Add `passwordHash` field to SharedNote
2. **Expiration**: Add `expiresAt` field to SharedNote
3. **Detailed Analytics**: Implement ShareView table for per-access tracking
4. **Multiple Shares Per Note**: Allow multiple share links with different settings
5. **Custom Share Settings**: Add `settings` JSON field for advanced options
